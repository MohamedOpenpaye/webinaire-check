<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>V√©rification d'√©ligibilit√©</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 400px;
      margin: auto;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #0d6efd;
      color: white;
      cursor: pointer;
      border: none;
    }
    #resultMessage {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h3>Acc√©dez au webinaire</h3>
  <p>V√©rification de votre √©ligibilit√© en cours...</p>
  <p id="resultMessage"></p>

  <script>
    function verifierEligibilite(retryCount = 0) {
      const result = document.getElementById("resultMessage");

      const visitorId = window.Intercom?.('getVisitorId');

      if (!visitorId) {
        if (retryCount < 10) {
          result.textContent = "‚è≥ Initialisation Intercom... (tentative " + (retryCount + 1) + ")";
          result.style.color = "#666";
          return setTimeout(() => verifierEligibilite(retryCount + 1), 1000);
        } else {
          result.textContent = "‚ùå Impossible de r√©cup√©rer votre identifiant Intercom.";
          result.style.color = "red";
          return;
        }
      }

      // ‚úÖ visitorId r√©cup√©r√©
      result.textContent = "‚è≥ V√©rification en cours...";
      result.style.color = "#333";

      fetch(`https://webinaire-check.vercel.app/api/check-eligibility?visitorId=${encodeURIComponent(visitorId)}`)
        .then(res => res.json())
        .then(data => {
          if (data.eligible) {
            result.textContent = "‚úÖ Acc√®s autoris√©. Chargement du contenu...";
            result.style.color = "green";

            // üîì D√©bloquer la section LearnWorlds
            window.parent.postMessage(
              { type: "afficher-section", sectionId: "section_1729871499679_376" },
              "*"
            );
          } else {
            result.textContent = "‚ùå Ce webinaire est r√©serv√© aux utilisateurs r√©cents.";
            result.style.color = "red";
          }
        })
        .catch(err => {
          console.error("Erreur API :", err);
          result.textContent = "‚ùå Erreur lors de la v√©rification.";
          result.style.color = "red";
        });
    }

    document.addEventListener("DOMContentLoaded", () => verifierEligibilite());
  </script>
</body>
</html>
